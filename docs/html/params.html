<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>params</title>
    <link rel="stylesheet" href="../css/sweetalert.css">
    <style>
        .table {
            display: table
        }

        .table-cell {
            padding: 10px 20px;
            display: inline-block;
        }
    </style>
</head>

<body>
    <div class="table">
        <div class="table-cell">
            <div style="height: 200px;">
                <div class="" data-name="text">Hello world!</div>
                <p>
                    <input name="name">
                    <div class="console">
                        <pre class="text"></pre>
                    </div>
                </p>
                <div>
                    更多信息, 请打开控制台查看
                </div>
            </div>
        </div>
        <div class="table-cell">
            <div style="height: 200px;">
                <p class="qrcode">
                </p>
                <button class="send">模拟扫码成功</button>
            </div>
        </div>
    </div>
    <script src="../js/jquery.min.js"></script>
    <script src="../js/sweetalert2.js"></script>
    <script src="../js/http.js"></script>
    <script src="../js/params.js"></script>
    <script src="../js/qrcode.min.js"></script>
    <script>
        $.fn.extend({
            qrcode: function (config) {
                if (!this.data("qrcode")) {
                    this.data("qrcode", instance.call(this, config).init());
                }
                return this.data("qrcode");
                function instance(config) {
                    var done = config.done;
                    var verify = config.verify;
                    return {
                        container: $(this).get(0),
                        QRCode: null,
                        key: '',
                        starttime: 0,
                        timeid: 0,
                        data: {},
                        createKey: function (len, radix) {
                            var str = '';
                            len = len <= 0 ? 64 : len;
                            radix = !radix || radix > 36 || radix <= 2 ? 36 : ~~radix;
                            while (len-- > 0) {
                                str += (~~(Math.random() * radix)).toString(radix);
                            }
                            return str;
                        },
                        http: $.extend({
                        }, config.http),
                        qrcode: $.extend({
                            height: 120,
                            width: 120
                        }, config.qrcode),
                        params: $.extend({}, config.params),
                        settings: $.extend({
                            expire: 0,
                            interval: 1000
                        }, config.settings),
                        options: $.extend({
                            a: 'codeLogin',
                        }, config.options),
                        init: function () {
                            if (typeof verify !== 'function') {
                                console.log('请设置verify方法');
                                return this;
                            }
                            this.key = this.createKey(64);
                            if (QRCode) {
                                $(this.container).html('');
                                this.QRCode = new QRCode(this.container, this.qrcode);
                                this.makeCode();
                                this.starttime = +new Date;
                                this.query();
                            }
                            return this;
                        },
                        query: function () {
                            var that = this;
                            var params = $.extend({}, that.http);
                            if (typeof params.data === 'function') {
                                params.data = params.data.call(this);
                            }
                            $.http(params, {
                                showError: false
                            }, function (data) {
                                if (verify.call(that, data)) {
                                    that.timeid = setTimeout(function () {
                                        if (!that.settings.expire || that.starttime + that.settings.expire > new Date) {
                                            that.query();
                                        } else {
                                            that.init();
                                        }
                                    }, that.settings.interval);
                                } else {
                                    done && done.call(that);
                                }
                            });
                        },
                        makeCode: function () {
                            var that = this;
                            myParams(this.params, function (data) {
                                that.data = data;
                                var result = $.extend({}, that.options, {
                                    key: that.key,
                                    token: token,
                                    data: data.json
                                });
                                that.QRCode.makeCode(JSON.stringify(result));
                            });
                        }
                    };
                }
            }
        });
        var token = 'f65fc8448wnvSU1yHijqU13STm7eglnXD1V5n11O+VoG3SVRfA+aq/WvZjBDAGRg0OX28U0beU9v8ofXCVk'
        var count = 100;
        $(".send").on("click",function(){
            $.http({
                url: '//api.597.cc/user/scan/0',
                type: 'POST',
                data: {
                    token: "f65fc8448wnvSU1yHijqU13STm7eglnXD1V5n11O+VoG3SVRfA+aq/WvZjBDAGRg0OX28U0beU9v8ofXCVk",
                    key: $(".qrcode").qrcode().key
                }
            }, function(data){
                console.log(data);
            })
        })
        $(".qrcode").qrcode({
            options: {},
            qrcode: {
                correctLevel: QRCode.CorrectLevel.L
            },
            http: {
                url: '//api.597.cc/user/scan',
                type: 'get',
                data: function(){
                    return {
                        key: this.key
                    };
                }
            },
            settings: {
                expire: 2 * 60 * 1000
            },
            params: {
                url: [
                    'id',
                    {
                        hash: function () {
                            return location.hash
                        }
                    }
                ],
                form: 'name',
                // var: 'token'
            },
            verify: function(data) {
                if (data.status - 1 === 0) {
                    return false;
                }
                return count-- > 0;
            },
            done: function(){
                    console.log('扫码成功', this);
                }
        });
    </script>
</body>

</html>
